<div class="form-container">
  <h2><i class="fas fa-credit-card"></i> Tarjetas de Crédito</h2>
  
  <div class="cards-tabs">
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="ciudad">Banco Ciudad</button>
      <button class="tab-button" data-tab="naranja">Tarjeta Naranja</button>
      <button class="tab-button" data-tab="otras">Otras Tarjetas</button>
    </div>
    
    <!-- Tab Banco Ciudad -->
    <div class="tab-content active" id="tab-ciudad">
      <div class="form-grid">
        <div class="form-group">
          <label for="ciudadFecha"><i class="fas fa-calendar"></i> Fecha de Pago</label>
          <input type="date" id="ciudadFecha" class="form-calendar-input">
        </div>
        
        <div class="form-group">
          <label for="ciudadMonto"><i class="fas fa-dollar-sign"></i> Monto a Pagar</label>
          <input type="number" id="ciudadMonto" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group">
          <label for="ciudadCuotas"><i class="fas fa-calendar-alt"></i> Cuotas</label>
          <select id="ciudadCuotas">
            <option value="1">1 cuota</option>
            <option value="3">3 cuotas</option>
            <option value="6">6 cuotas</option>
            <option value="12">12 cuotas</option>
            <option value="otras">Otras cuotas</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="ciudadConcepto"><i class="fas fa-tag"></i> Concepto</label>
          <input type="text" id="ciudadConcepto" placeholder="¿Qué compraste?">
        </div>
        
        <div class="form-group">
          <label for="ciudadComprobante"><i class="fas fa-file-invoice"></i> Comprobante</label>
          <div class="file-input-container">
            <input type="file" id="ciudadComprobante" accept="image/*,.pdf" style="display:none">
            <button type="button" id="ciudadFileBtn" class="file-btn">
              <i class="fas fa-camera"></i> Subir Comprobante
            </button>
            <span id="ciudadFileName" class="file-name">No seleccionado</span>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="ciudadDescripcion"><i class="fas fa-align-left"></i> Descripción</label>
          <textarea id="ciudadDescripcion" placeholder="Detalles adicionales del pago..." rows="3"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="saveCiudad" class="btn-primary">
          <i class="fas fa-save"></i> Guardar Pago
        </button>
        <button type="button" id="clearCiudad" class="btn-secondary">
          <i class="fas fa-broom"></i> Limpiar Formulario
        </button>
      </div>
      
      <div class="records-section">
        <h3><i class="fas fa-history"></i> Historial Banco Ciudad</h3>
        <div class="summary-cards mini">
          <div class="summary-card">
            <h4>Total Este Mes</h4>
            <div class="summary-amount" id="ciudadTotal">$0</div>
          </div>
          <div class="summary-card">
            <h4>Cantidad de Pagos</h4>
            <div class="summary-amount" id="ciudadCount">0</div>
          </div>
        </div>
        <div id="ciudadRecords" class="records-list"></div>
      </div>
    </div>
    
    <!-- Tab Tarjeta Naranja -->
    <div class="tab-content" id="tab-naranja">
      <div class="form-grid">
        <div class="form-group">
          <label for="naranjaFecha"><i class="fas fa-calendar"></i> Fecha de Pago</label>
          <input type="date" id="naranjaFecha" class="form-calendar-input">
        </div>
        
        <div class="form-group">
          <label for="naranjaMonto"><i class="fas fa-dollar-sign"></i> Monto a Pagar</label>
          <input type="number" id="naranjaMonto" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group">
          <label for="naranjaCuotas"><i class="fas fa-calendar-alt"></i> Cuotas</label>
          <select id="naranjaCuotas">
            <option value="1">1 cuota</option>
            <option value="3">3 cuotas</option>
            <option value="6">6 cuotas</option>
            <option value="12">12 cuotas</option>
            <option value="otras">Otras cuotas</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="naranjaConcepto"><i class="fas fa-tag"></i> Concepto</label>
          <input type="text" id="naranjaConcepto" placeholder="¿Qué compraste?">
        </div>
        
        <div class="form-group">
          <label for="naranjaComprobante"><i class="fas fa-file-invoice"></i> Comprobante</label>
          <div class="file-input-container">
            <input type="file" id="naranjaComprobante" accept="image/*,.pdf" style="display:none">
            <button type="button" id="naranjaFileBtn" class="file-btn">
              <i class="fas fa-camera"></i> Subir Comprobante
            </button>
            <span id="naranjaFileName" class="file-name">No seleccionado</span>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="naranjaDescripcion"><i class="fas fa-align-left"></i> Descripción</label>
          <textarea id="naranjaDescripcion" placeholder="Detalles adicionales del pago..." rows="3"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="saveNaranja" class="btn-primary">
          <i class="fas fa-save"></i> Guardar Pago
        </button>
        <button type="button" id="clearNaranja" class="btn-secondary">
          <i class="fas fa-broom"></i> Limpiar Formulario
        </button>
      </div>
      
      <div class="records-section">
        <h3><i class="fas fa-history"></i> Historial Tarjeta Naranja</h3>
        <div class="summary-cards mini">
          <div class="summary-card">
            <h4>Total Este Mes</h4>
            <div class="summary-amount" id="naranjaTotal">$0</div>
          </div>
          <div class="summary-card">
            <h4>Cantidad de Pagos</h4>
            <div class="summary-amount" id="naranjaCount">0</div>
          </div>
        </div>
        <div id="naranjaRecords" class="records-list"></div>
      </div>
    </div>
    
    <!-- Tab Otras Tarjetas -->
    <div class="tab-content" id="tab-otras">
      <div class="form-grid">
        <div class="form-group">
          <label for="otrasTarjeta"><i class="fas fa-credit-card"></i> Nombre de la Tarjeta</label>
          <input type="text" id="otrasTarjeta" placeholder="Ej: Visa, Mastercard, etc.">
        </div>
        
        <div class="form-group">
          <label for="otrasFecha"><i class="fas fa-calendar"></i> Fecha de Pago</label>
          <input type="date" id="otrasFecha" class="form-calendar-input">
        </div>
        
        <div class="form-group">
          <label for="otrasMonto"><i class="fas fa-dollar-sign"></i> Monto a Pagar</label>
          <input type="number" id="otrasMonto" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group">
          <label for="otrasCuotas"><i class="fas fa-calendar-alt"></i> Cuotas</label>
          <select id="otrasCuotas">
            <option value="1">1 cuota</option>
            <option value="3">3 cuotas</option>
            <option value="6">6 cuotas</option>
            <option value="12">12 cuotas</option>
            <option value="otras">Otras cuotas</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="otrasConcepto"><i class="fas fa-tag"></i> Concepto</label>
          <input type="text" id="otrasConcepto" placeholder="¿Qué compraste?">
        </div>
        
        <div class="form-group">
          <label for="otrasComprobante"><i class="fas fa-file-invoice"></i> Comprobante</label>
          <div class="file-input-container">
            <input type="file" id="otrasComprobante" accept="image/*,.pdf" style="display:none">
            <button type="button" id="otrasFileBtn" class="file-btn">
              <i class="fas fa-camera"></i> Subir Comprobante
            </button>
            <span id="otrasFileName" class="file-name">No seleccionado</span>
          </div>
        </div>
        
        <div class="form-group full-width">
          <label for="otrasDescripcion"><i class="fas fa-align-left"></i> Descripción</label>
          <textarea id="otrasDescripcion" placeholder="Detalles adicionales del pago..." rows="3"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" id="saveOtras" class="btn-primary">
          <i class="fas fa-save"></i> Guardar Pago
        </button>
        <button type="button" id="clearOtras" class="btn-secondary">
          <i class="fas fa-broom"></i> Limpiar Formulario
        </button>
      </div>
      
      <div class="records-section">
        <h3><i class="fas fa-history"></i> Historial Otras Tarjetas</h3>
        <div class="summary-cards mini">
          <div class="summary-card">
            <h4>Total Este Mes</h4>
            <div class="summary-amount" id="otrasTotal">$0</div>
          </div>
          <div class="summary-card">
            <h4>Cantidad de Pagos</h4>
            <div class="summary-amount" id="otrasCount">0</div>
          </div>
        </div>
        <div id="otrasRecords" class="records-list"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeTarjetasForm();
});

function initializeTarjetasForm() {
  // Inicializar tabs
  initializeTabs();
  
  // Inicializar formularios de cada tarjeta
  initializeCiudadForm();
  initializeNaranjaForm();
  initializeOtrasForm();
  
  // Cargar registros existentes
  loadTarjetasRecords();
}

function initializeTabs() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Remover clase active de todos los botones y contenidos
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Agregar clase active al botón clickeado
      this.classList.add('active');
      
      // Mostrar el contenido correspondiente
      document.getElementById(`tab-${tabId}`).classList.add('active');
    });
  });
}

function initializeCiudadForm() {
  // Configurar fecha actual por defecto
  const today = new Date().toISOString().split('T')[0];
  const fechaInput = document.getElementById('ciudadFecha');
  if (fechaInput) fechaInput.value = today;
  
  // Manejar subida de archivos
  const fileBtn = document.getElementById('ciudadFileBtn');
  const fileInput = document.getElementById('ciudadComprobante');
  const fileName = document.getElementById('ciudadFileName');
  
  if (fileBtn && fileInput) {
    fileBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }
  
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0 && fileName) {
        fileName.textContent = e.target.files[0].name;
      }
    });
  }
  
  // Guardar pago
  const saveBtn = document.getElementById('saveCiudad');
  if (saveBtn) {
    saveBtn.addEventListener('click', function() {
      saveTarjetaRecord('ciudad');
    });
  }
  
  // Limpiar formulario
  const clearBtn = document.getElementById('clearCiudad');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      clearTarjetaForm('ciudad');
    });
  }
}

function initializeNaranjaForm() {
  // Configurar fecha actual por defecto
  const today = new Date().toISOString().split('T')[0];
  const fechaInput = document.getElementById('naranjaFecha');
  if (fechaInput) fechaInput.value = today;
  
  // Manejar subida de archivos
  const fileBtn = document.getElementById('naranjaFileBtn');
  const fileInput = document.getElementById('naranjaComprobante');
  const fileName = document.getElementById('naranjaFileName');
  
  if (fileBtn && fileInput) {
    fileBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }
  
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0 && fileName) {
        fileName.textContent = e.target.files[0].name;
      }
    });
  }
  
  // Guardar pago
  const saveBtn = document.getElementById('saveNaranja');
  if (saveBtn) {
    saveBtn.addEventListener('click', function() {
      saveTarjetaRecord('naranja');
    });
  }
  
  // Limpiar formulario
  const clearBtn = document.getElementById('clearNaranja');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      clearTarjetaForm('naranja');
    });
  }
}

function initializeOtrasForm() {
  // Configurar fecha actual por defecto
  const today = new Date().toISOString().split('T')[0];
  const fechaInput = document.getElementById('otrasFecha');
  if (fechaInput) fechaInput.value = today;
  
  // Manejar subida de archivos
  const fileBtn = document.getElementById('otrasFileBtn');
  const fileInput = document.getElementById('otrasComprobante');
  const fileName = document.getElementById('otrasFileName');
  
  if (fileBtn && fileInput) {
    fileBtn.addEventListener('click', function() {
      fileInput.click();
    });
  }
  
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0 && fileName) {
        fileName.textContent = e.target.files[0].name;
      }
    });
  }
  
  // Guardar pago
  const saveBtn = document.getElementById('saveOtras');
  if (saveBtn) {
    saveBtn.addEventListener('click', function() {
      saveTarjetaRecord('otras');
    });
  }
  
  // Limpiar formulario
  const clearBtn = document.getElementById('clearOtras');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      clearTarjetaForm('otras');
    });
  }
}

function saveTarjetaRecord(tipo) {
  const k = ensureMonth();
  const fecha = document.getElementById(`${tipo}Fecha`).value;
  const montoInput = document.getElementById(`${tipo}Monto`);
  const monto = parseFloat(montoInput.value);
  const cuotas = document.getElementById(`${tipo}Cuotas`).value;
  const concepto = document.getElementById(`${tipo}Concepto`).value;
  const descripcion = document.getElementById(`${tipo}Descripcion`).value;
  const fileInput = document.getElementById(`${tipo}Comprobante`);
  
  // Para "otras" tarjetas, también necesitamos el nombre
  let nombreTarjeta = '';
  if (tipo === 'otras') {
    nombreTarjeta = document.getElementById('otrasTarjeta').value;
    if (!nombreTarjeta.trim()) {
      alert('Por favor ingrese el nombre de la tarjeta');
      return;
    }
  }
  
  if (!fecha) {
    alert('Por favor seleccione una fecha');
    return;
  }
  
  if (!monto || monto <= 0 || isNaN(monto)) {
    alert('Por favor ingrese un monto válido');
    montoInput.focus();
    return;
  }
  
  if (!concepto.trim()) {
    alert('Por favor ingrese el concepto del pago');
    return;
  }
  
  if (!state[k].tarjetas) state[k].tarjetas = [];
  
  const record = {
    id: crypto.randomUUID ? crypto.randomUUID() : generateUUID(),
    tipo: tipo,
    fecha: fecha,
    monto: monto,
    cuotas: cuotas,
    concepto: concepto,
    descripcion: descripcion,
    timestamp: new Date().toISOString()
  };
  
  // Agregar nombre de tarjeta para "otras"
  if (tipo === 'otras') {
    record.nombreTarjeta = nombreTarjeta;
  }
  
  // Manejar archivo si existe
  if (fileInput && fileInput.files.length > 0) {
    const file = fileInput.files[0];
    record.comprobanteNombre = file.name;
  }
  
  completeSaveTarjeta(record, k, tipo);
}

function completeSaveTarjeta(record, k, tipo) {
  state[k].tarjetas.push(record);
  save();
  
  alert(`Pago de tarjeta ${getTipoTarjetaText(tipo)} guardado correctamente`);
  loadTarjetasRecords();
  if (typeof renderKPIs === 'function') {
    renderKPIs();
  }
  clearTarjetaForm(tipo);
}

function loadTarjetasRecords() {
  const k = ensureMonth();
  
  // Cargar registros para cada tipo de tarjeta
  loadTarjetaRecordsByType('ciudad', k);
  loadTarjetaRecordsByType('naranja', k);
  loadTarjetaRecordsByType('otras', k);
}

function loadTarjetaRecordsByType(tipo, k) {
  const recordsContainer = document.getElementById(`${tipo}Records`);
  const totalElement = document.getElementById(`${tipo}Total`);
  const countElement = document.getElementById(`${tipo}Count`);
  
  if (!recordsContainer) return;
  
  const allRecords = state[k].tarjetas || [];
  const records = allRecords.filter(record => record.tipo === tipo);
  
  // Calcular totales
  const total = records.reduce((sum, record) => sum + record.monto, 0);
  
  if (totalElement) totalElement.textContent = fmt(total);
  if (countElement) countElement.textContent = records.length;
  
  if (records.length === 0) {
    recordsContainer.innerHTML = `
      <div class="no-records">
        <i class="fas fa-inbox"></i>
        <p>No hay pagos registrados para ${getTipoTarjetaText(tipo)} este mes</p>
      </div>
    `;
    return;
  }
  
  // Ordenar por fecha (más reciente primero)
  const sortedRecords = [...records].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  
  recordsContainer.innerHTML = sortedRecords.map(record => `
    <div class="record-item">
      <div class="record-info">
        <div class="record-main">
          <span class="record-date">${formatDate(record.fecha)}</span>
          <span class="record-amount">${fmt(record.monto)}</span>
        </div>
        <div class="record-details">
          <span class="record-categoria ${record.tipo}">${getTipoTarjetaText(record.tipo)}</span>
          ${record.nombreTarjeta ? `<span class="record-tarjeta-nombre">${record.nombreTarjeta}</span>` : ''}
          <span class="record-concepto">${record.concepto}</span>
          <span class="record-cuotas">${record.cuotas} cuota${record.cuotas !== '1' ? 's' : ''}</span>
          ${record.descripcion ? `<span class="record-desc">${record.descripcion}</span>` : ''}
          ${record.comprobanteNombre ? `
            <span class="record-file">
              <i class="fas fa-paperclip"></i> ${record.comprobanteNombre}
            </span>
          ` : ''}
        </div>
      </div>
      <div class="record-actions">
        <button class="btn-icon danger" onclick="deleteTarjetaRecord('${record.id}', '${tipo}')" title="Eliminar registro">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
}

function deleteTarjetaRecord(id, tipo) {
  if (!confirm('¿Está seguro de que desea eliminar este pago de tarjeta?')) {
    return;
  }
  
  const k = ensureMonth();
  const index = state[k].tarjetas.findIndex(record => record.id === id);
  
  if (index !== -1) {
    state[k].tarjetas.splice(index, 1);
    save();
    loadTarjetasRecords();
    if (typeof renderKPIs === 'function') {
      renderKPIs();
    }
    alert('Pago de tarjeta eliminado correctamente');
  }
}

function clearTarjetaForm(tipo) {
  const fechaInput = document.getElementById(`${tipo}Fecha`);
  const montoInput = document.getElementById(`${tipo}Monto`);
  const cuotasSelect = document.getElementById(`${tipo}Cuotas`);
  const conceptoInput = document.getElementById(`${tipo}Concepto`);
  const descripcionInput = document.getElementById(`${tipo}Descripcion`);
  const fileName = document.getElementById(`${tipo}FileName`);
  const fileInput = document.getElementById(`${tipo}Comprobante`);
  
  if (fechaInput) fechaInput.value = '';
  if (montoInput) montoInput.value = '';
  if (cuotasSelect) cuotasSelect.value = '1';
  if (conceptoInput) conceptoInput.value = '';
  if (descripcionInput) descripcionInput.value = '';
  if (fileName) fileName.textContent = 'No seleccionado';
  if (fileInput) fileInput.value = '';
  
  // Para "otras" tarjetas, limpiar también el nombre
  if (tipo === 'otras') {
    const tarjetaInput = document.getElementById('otrasTarjeta');
    if (tarjetaInput) tarjetaInput.value = '';
  }
  
  // Establecer fecha actual por defecto
  const today = new Date().toISOString().split('T')[0];
  if (fechaInput) fechaInput.value = today;
}

function getTipoTarjetaText(tipo) {
  const tipos = {
    'ciudad': 'Banco Ciudad',
    'naranja': 'Tarjeta Naranja',
    'otras': 'Otras Tarjetas'
  };
  return tipos[tipo] || tipo;
}
</script>

<style>
.cards-tabs {
  margin-top: 20px;
}

.tab-buttons {
  display: flex;
  background: #f8fafc;
  border-radius: 8px 8px 0 0;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  border-bottom: none;
}

.tab-button {
  flex: 1;
  padding: 12px 16px;
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
}

.tab-button:hover {
  background: #f1f5f9;
  color: #374151;
}

.tab-button.active {
  background: white;
  color: #3b82f6;
  border-bottom-color: #3b82f6;
}

.tab-content {
  display: none;
  padding: 24px;
  background: white;
  border: 1px solid #e5e7eb;
  border-top: none;
  border-radius: 0 0 8px 8px;
}

.tab-content.active {
  display: block;
}

.record-categoria.ciudad {
  background: #3b82f6;
  color: white;
}

.record-categoria.naranja {
  background: #f59e0b;
  color: white;
}

.record-categoria.otras {
  background: #8b5cf6;
  color: white;
}

.record-tarjeta-nombre {
  background: #e5e7eb;
  color: #374151;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.record-concepto {
  font-weight: 600;
  color: #1f2937;
}

.record-cuotas {
  color: #6b7280;
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .tab-buttons {
    flex-direction: column;
  }
  
  .tab-button {
    border-bottom: 1px solid #e5e7eb;
    border-right: none;
    text-align: left;
  }
  
  .tab-button.active {
    border-bottom: 3px solid #3b82f6;
  }
}
</style>